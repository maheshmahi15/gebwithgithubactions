name: sqa_automation_reusable
permissions:
  id-token: write
  contents: read
  pull-requests: write
  actions: read
  security-events: write
'on':
  workflow_call:
    inputs:
      suite:
        description: Test Suite to execute
        required: true
        type: string
      testUrl:
        type: string
        description: Test URL to be used
        required: true
      branch:
        type: string
        description: Test URL to be used
        default: '${{ github.ref_name }}'
        required: false
jobs:
  sqa_test_automation_flow:
    name: sqa_automation_flow
    runs-on: self-hosted
    steps:
      - name: Git checkout
        uses: actions/checkout@v3
        with:
          ref: '${{ inputs.branch }}'
          fetch-depth: 1
      - name: Run Test
        id: test_execution
        run: |
          sudo ./gradlew chromeHeadlessTest
        continue-on-error: true
      - name: Load test report history
        uses: actions/checkout@v3
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages
      - name: Build test report
        uses: simple-elf/allure-report-action@v1.7
        if: always()
        with:
          gh_pages: gh-pages
          allure_history: allure-history
          allure_results: build/allure-results
      - name: Publish test report
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: '${{ secrets.GITHUB_TOKEN }}'
          publish_branch: gh-pages
          publish_dir: allure-history
